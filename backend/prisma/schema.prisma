generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model app_downloads {
  id           String     @id
  appId        String
  userId       String?
  version      AppVersion
  orderId      String?
  amount       Float      @default(0)
  downloadedAt DateTime   @default(now())
  apps         apps       @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
}

model app_reviews {
  id         String   @id
  appId      String
  userId     String
  userName   String
  userAvatar String?
  rating     Int
  comment    String
  helpful    Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  apps       apps     @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
}

model apps {
  id                String          @id
  title             String
  slug              String          @unique
  developer         String
  description       String
  shortDescription  String?
  iconUrl           String
  coverImages       String[]        @default([])
  videoUrl          String?
  rating            Float           @default(0)
  totalRatings      Int             @default(0)
  downloads         Int             @default(0)
  fileSize          String
  version           String          @default("1.0.0")
  lastUpdate        DateTime        @default(now())
  ageRating         String          @default("Livre")
  category          String
  tags              String[]        @default([])
  freeWithAdsUrl    String?
  freeWithAdsActive Boolean         @default(true)
  paidNoAdsUrl      String?
  paidNoAdsPrice    Float           @default(0)
  paidNoAdsActive   Boolean         @default(false)
  adsenseEnabled    Boolean         @default(false)
  adsenseSlot       String?
  whatsNew          String?
  permissions       String[]        @default([])
  requiresInternet  Boolean         @default(false)
  inAppPurchases    Boolean         @default(false)
  status            AppStatus       @default(DRAFT)
  featured          Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  app_downloads     app_downloads[]
  app_reviews       app_reviews[]

  @@index([category])
  @@index([featured])
  @@index([status])
}

model badges {
  id            String        @id
  name          String
  description   String
  type          BadgeType
  icon          String
  requiredValue Int
  points        Int           @default(0)
  rarity        String        @default("COMMON")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user_badges   user_badges[]
}

model cart_items {
  id        String   @id
  userId    String
  productId String
  quantity  Int      @default(1)
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

model combo_products {
  id        String   @id
  comboId   String
  productId String
  createdAt DateTime @default(now())
  combos    combos   @relation(fields: [comboId], references: [id], onDelete: Cascade)

  @@unique([comboId, productId])
  @@index([comboId])
}

model combos {
  id             String           @id
  title          String
  description    String
  discountPrice  Float
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  producerId     String
  combo_products combo_products[]
  users          users            @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@index([producerId])
}

model commissions {
  id            String           @id
  orderId       String           @unique
  producerId    String
  amount        Float
  status        CommissionStatus @default(PENDING)
  transferId    String?
  paidAt        DateTime?
  processingAt  DateTime?
  failureReason String?
  failedAt      DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  orders        orders           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  users         users            @relation(fields: [producerId], references: [id])

  @@index([producerId])
  @@index([status])
}

model leaderboards {
  id          String    @id
  period      String
  category    String
  userId      String
  userName    String
  userAvatar  String?
  value       Int
  rank        Int
  periodStart DateTime
  periodEnd   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([period, category, userId, periodStart])
  @@index([period, category, rank])
}

model missions {
  id             String          @id
  title          String
  description    String
  type           MissionType
  targetValue    Int
  pointsReward   Int
  icon           String?
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean         @default(true)
  maxCompletions Int             @default(1)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user_missions  user_missions[]
}

model order_bumps {
  id              String           @id
  productId       String
  title           String
  description     String
  discountPercent Float            @default(0)
  triggerType     OrderBumpTrigger @default(CATEGORY)
  triggerValues   String[]         @default([])
  producerId      String
  isActive        Boolean          @default(true)
  priority        Int              @default(0)
  impressions     Int              @default(0)
  clicks          Int              @default(0)
  conversions     Int              @default(0)
  revenue         Float            @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  users           users            @relation(fields: [producerId], references: [id], onDelete: Cascade)
  products        products         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([producerId])
  @@index([triggerType])
}

model orders {
  id             String       @id
  productId      String?
  buyerId        String
  amount         Float
  platformFee    Float
  producerAmount Float
  paymentMethod  String       @default("PIX")
  paymentId      String?
  paymentStatus  String?
  paymentDetails Json?
  paidAt         DateTime?
  status         OrderStatus  @default(PENDING)
  cancelReason   String?
  cancelledAt    DateTime?
  refundReason   String?
  refundAmount   Float?
  refundedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  metadata       Json?
  commissions    commissions?
  pix_transfers  pix_transfers[]
  buyer          users        @relation(fields: [buyerId], references: [id])
  product        products?    @relation(fields: [productId], references: [id])

  @@index([buyerId])
  @@index([productId])
  @@index([status])
}

model points_history {
  id                String            @id
  userId            String
  points            Int
  reason            String
  description       String?
  referenceId       String?
  referenceType     String?
  createdAt         DateTime          @default(now())
  user_gamification user_gamification @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model products {
  id                  String        @id
  title               String
  slug                String        @unique
  description         String
  price               Float
  category            String
  thumbnailUrl        String?
  videoUrl            String?
  filesUrl            String[]      @default([])
  features            String[]      @default([])
  requirements        String?
  targetAudience      String?
  duration            String?
  level               String        @default("BEGINNER")
  language            String        @default("Portuguese")
  certificateIncluded Boolean       @default(false)
  hasSupport          Boolean       @default(false)
  supportDuration     Int?
  producerId          String
  status              ProductStatus @default(DRAFT)
  featured            Boolean       @default(false)
  views               Int           @default(0)
  sales               Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  approvedAt          DateTime?
  approvedBy          String?
  rejectedAt          DateTime?
  rejectedBy          String?
  rejectionReason     String?
  cart_items          cart_items[]
  order_bumps         order_bumps[]
  orders              orders[]
  producer            users         @relation(fields: [producerId], references: [id], onDelete: Cascade)
  reviews             reviews[]

  @@index([category])
  @@index([producerId])
  @@index([status])
}

model reviews {
  id        String   @id
  productId String
  userId    String
  rating    Int
  comment   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([productId])
}

model user_badges {
  id                String            @id
  userId            String
  badgeId           String
  earnedAt          DateTime          @default(now())
  progress          Int               @default(0)
  badges            badges            @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user_gamification user_gamification @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model user_gamification {
  id               String           @id
  userId           String           @unique
  totalPoints      Int              @default(0)
  currentLevel     Int              @default(1)
  levelProgress    Int              @default(0)
  currentStreak    Int              @default(0)
  longestStreak    Int              @default(0)
  lastActivityDate DateTime?
  coursesCompleted Int              @default(0)
  totalPurchases   Int              @default(0)
  totalSales       Int              @default(0)
  reviewsMade      Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  points_history   points_history[]
  user_badges      user_badges[]
  users            users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  user_missions    user_missions[]
}

model user_missions {
  id                String            @id
  userId            String
  missionId         String
  status            MissionStatus     @default(ACTIVE)
  progress          Int               @default(0)
  completedAt       DateTime?
  claimedAt         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  missions          missions          @relation(fields: [missionId], references: [id], onDelete: Cascade)
  user_gamification user_gamification @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, missionId])
  @@index([status])
  @@index([userId])
}

model users {
  id                     String             @id
  name                   String
  email                  String             @unique
  password               String
  role                   UserRole           @default(BUYER)
  status                 UserStatus         @default(ACTIVE)
  avatar                 String?
  bio                    String?
  phone                  String?
  cpf                    String?            @unique
  pixKey                 String?
  emailVerified          Boolean            @default(false)
  emailVerifiedAt        DateTime?
  emailVerificationToken String?
  resetPasswordToken     String?
  resetPasswordExpires   DateTime?
  suspensionReason       String?
  suspendedUntil         DateTime?
  banReason              String?
  bannedAt               DateTime?
  permanentBan           Boolean            @default(false)
  lastLoginAt            DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  googleId               String?            @unique
  bankAccount            String?
  bankAccountType        String?
  bankAgency             String?
  bankName               String?
  businessAddress        String?
  businessDocument       String?
  businessName           String?
  businessPhone          String?
  producerApproved       Boolean            @default(false)
  producerApprovedAt     DateTime?
  // Mercado Pago OAuth fields for split payments
  mercadopagoAccessToken    String?
  mercadopagoRefreshToken   String?
  mercadopagoUserId         String?
  mercadopagoPublicKey      String?
  mercadopagoAccountLinked  Boolean            @default(false)
  mercadopagoLinkedAt       DateTime?
  mercadopagoTokenExpiresAt DateTime?
  // PIX automatic payment fields
  pixKeyType                String?            // CPF, EMAIL, PHONE, RANDOM
  pixBankName               String?            // Bank name for display
  pixAccountHolder          String?            // Account holder name
  pixAutoPaymentEnabled     Boolean            @default(false)
  pixVerifiedAt             DateTime?
  cart_items             cart_items[]
  combos                 combos[]
  commissions            commissions[]
  order_bumps            order_bumps[]
  orders                 orders[]
  pix_transfers          pix_transfers[]
  products               products[]
  reviews                reviews[]
  user_gamification      user_gamification?
}

model pix_transfers {
  id              String            @id
  orderId         String
  producerId      String
  amount          Float
  pixKey          String
  pixKeyType      String
  status          PixTransferStatus @default(PENDING)
  mercadopagoId   String?           // MP transfer ID
  errorMessage    String?
  processedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  orders          orders            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  producer        users             @relation(fields: [producerId], references: [id])

  @@index([orderId])
  @@index([producerId])
  @@index([status])
}

enum PixTransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AppStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AppVersion {
  FREE_WITH_ADS
  PAID_NO_ADS
}

enum BadgeType {
  FIRST_PURCHASE
  FIRST_SALE
  COURSES_COMPLETED
  REVIEWS_MADE
  STREAK_ACHIEVEMENT
  SALES_MILESTONE
  ENGAGEMENT
  SPECIAL
}

enum CommissionStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum MissionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CLAIMED
}

enum MissionType {
  DAILY
  WEEKLY
  MONTHLY
  SPECIAL
}

enum OrderBumpTrigger {
  CATEGORY
  PRODUCT
  ANY
}

enum OrderStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  PENDING_APPROVAL
  REJECTED
}

enum UserRole {
  ADMIN
  PRODUCER
  BUYER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}
